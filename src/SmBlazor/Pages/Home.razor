@page "/"
@using SmBlazor.Services
@using SmBlazor.Utils
@inject SmService Sm
@inject IJSRuntime JS
@inject NavigationManager Nav

<PageTitle>Scrum Master</PageTitle>

<table style="width:100%;">
    <tr>
        <td colspan="3" style="padding: 15px;">&nbsp;</td>
    </tr>
    <tr>
        <td colspan="3" style="text-align: left;">
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <div style="display: flex; align-items: center;">
                    <span id="today" style="font-weight: 600;">@TodayText</span>
                    &nbsp;<span id="statusIndicator" title="@StatusTooltip">@((MarkupString)StatusIndicatorHtml)</span>
                </div>
                <div>
                    <button @onclick="()=>ChangeDay(-1)" title="Previous day" style="border:none;background:none;cursor:pointer;">
                        <i class="fa fa-chevron-left"></i>
                    </button>
                    <button @onclick="()=>ChangeDay(1)" title="Next day" style="border:none;background:none;cursor:pointer;">
                        <i class="fa fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        </td>
    </tr>
    <tr>
        <td style="vertical-align: top; text-align: left; width: 48%;">
            <h5 id="firstWeekTitle" style="font-weight:@(IsFirstWeekCurrentWeek ? "bold" : "normal")">@FirstWeekTitle</h5>
            <div id="firstWeek">@((MarkupString)FirstWeekHtml)</div>
            <h5 id="secondWeekTitle" style="font-weight:@(IsSecondWeekCurrentWeek ? "bold" : "normal")">@SecondWeekTitle</h5>
            <div id="secondWeek">@((MarkupString)SecondWeekHtml)</div>
        </td>
        <td style="width: 2%;">&nbsp;</td>
        <td style="vertical-align: top; width: 50%;">
            <h5 class="calendar">Who's Out</h5>
            <div id="whosOut">@((MarkupString)WhosOutHtml)</div>
        </td>
    </tr>
</table>

@code {
    private bool _initialized;
    private bool _showCheckIcon;
    private bool _wasLoading;
    private bool _showCheckIconInProgress;

    private bool _todayFromQueryApplied;

    protected override async Task OnInitializedAsync()
    {
        // Apply ?today=... once before first data load
        ApplyTodayFromQueryString();

        await LogToConsoleAsync($"[OnInitializedAsync] _wasLoading={_wasLoading}, Sm.IsLoading={Sm.IsLoading}, _showCheckIcon={_showCheckIcon}");
        await Sm.InitializeAsync();
        _initialized = true;
        await InvokeAsync(StateHasChanged);
        var refreshTask = Sm.RefreshAsync();
        await InvokeAsync(StateHasChanged);
        await refreshTask;
        await InvokeAsync(StateHasChanged);
    }

    private void ApplyTodayFromQueryString()
    {
        if (_todayFromQueryApplied) return;
        _todayFromQueryApplied = true;

        try
        {
            // NavigationManager.Uri includes the full URL (with query)
            var uri = new Uri(Nav.Uri);
            var query = uri.Query;
            if (string.IsNullOrWhiteSpace(query)) return;

            // Minimal query parsing; supports e.g. ?today=+1 or ?today=2026-02-01
            var parts = query.TrimStart('?').Split('&', StringSplitOptions.RemoveEmptyEntries);
            string? todayParam = null;
            foreach (var part in parts)
            {
                var kv = part.Split('=', 2);
                if (kv.Length != 2) continue;
                var key = Uri.UnescapeDataString(kv[0]);
                if (!string.Equals(key, "today", StringComparison.OrdinalIgnoreCase)) continue;
                todayParam = Uri.UnescapeDataString(kv[1]);
                break;
            }

            if (string.IsNullOrWhiteSpace(todayParam)) return;

            // Same semantics as old HTML:
            // - If param starts with space/+/-/0 and is numeric -> offset days
            // - Else if is a valid date -> use that date
            todayParam = todayParam.Trim();

            if (todayParam.Length > 0 && (todayParam[0] == ' ' || todayParam[0] == '+' || todayParam[0] == '-' || todayParam[0] == '0'))
            {
                if (int.TryParse(todayParam, out var offsetDays))
                {
                    Sm.Today = Sm.Today.AddDays(offsetDays).Date;
                    return;
                }
            }

            // Accept ISO dates first; fall back to DateTime.TryParse
            if (DateTime.TryParse(todayParam, out var parsed))
            {
                Sm.Today = parsed.Date;
            }
        }
        catch
        {
            // ignore invalid query
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await LogToConsoleAsync($"[OnAfterRenderAsync] _wasLoading={_wasLoading}, Sm.IsLoading={Sm.IsLoading}, _showCheckIcon={_showCheckIcon}");
        if (!_showCheckIconInProgress && _wasLoading && !Sm.IsLoading)
        {
            _showCheckIconInProgress = true;
            _showCheckIcon = true;
            _wasLoading = Sm.IsLoading;
            StateHasChanged();
            await Task.Delay(5000);
            _showCheckIcon = false;
            _showCheckIconInProgress = false;
            StateHasChanged();
        }
        else
        {
            _wasLoading = Sm.IsLoading;
        }
    }

    private async Task LogToConsoleAsync(string message)
    {
        await JS.InvokeVoidAsync("console.log", message);
    }

    private string TodayText
    {
        get
        {
            var today = Sm.Today;
            var dow = GetDayOfWeek(today.DayOfWeek);
            return $"{FormatDayMonth(today)}.{today.Year} - {dow}";
        }
    }

    private string StatusIndicatorHtml
    {
        get
        {
            if (Sm.IsLoading)
            {
                var html = "";
                if (Sm.HasCachedData)
                    html += "<i class=\"fa-solid fa-wifi\"></i>";
                html += (html.Length > 0 ? "&nbsp;" : "");
                html += "<i class=\"fa-solid fa-spinner fa-spin sm-spin\"></i>";
                if (Sm.CacheNotAllowed)
                    html += "&nbsp;<i class=\"fa-solid fa-exclamation-triangle\"></i>";
                if (Sm.Today.NonWorkingDay())
                    html += "&nbsp;<i class=\"fa-solid fa-bed\"></i>";
                if (Sm.IsHolidayForAllTeamMembers(Sm.Today))
                    html += "&nbsp;<i class=\"fa-solid fa-gift\"></i>";
                return html;
            }

            var done = "";
            if (_showCheckIcon)
                done += "<i class=\"fa-solid fa-check\"></i>";
            if (Sm.CacheNotAllowed)
                done += "&nbsp;<i class=\"fa-solid fa-exclamation-triangle\"></i>";
            if (Sm.Today.NonWorkingDay())
                done += "&nbsp;<i class=\"fa-solid fa-bed\"></i>";
            if (Sm.IsHolidayForAllTeamMembers(Sm.Today))
                done += "&nbsp;<i class=\"fa-solid fa-gift\"></i>";
            return done;
        }
    }

    private string StatusTooltip
    {
        get
        {
            var parts = new List<string>();
            if (!string.IsNullOrWhiteSpace(Sm.LastFetchStatus))
                parts.Add(Sm.LastFetchStatus);
            if (!string.IsNullOrWhiteSpace(Sm.LastFetchError))
                parts.Add("ERROR: " + Sm.LastFetchError);

            return parts.Count == 0 ? "" : string.Join("\n", parts);
        }
    }

    private bool IsFirstWeekCurrentWeek => IsFirstWeekCurrentWeekImpl(Sm.Today.GetPreviousMonday());
    private bool IsSecondWeekCurrentWeek => !IsFirstWeekCurrentWeek;

    private string FirstWeekTitle
    {
        get
        {
            var thisMonday = Sm.Today.GetPreviousMonday();
            var firstMonday = IsFirstWeekCurrentWeek ? thisMonday : thisMonday.AddDays(-7);
            return $"1. Week {FormatDayMonth(firstMonday)}-{FormatDayMonth(firstMonday.AddDays(4))}";
        }
    }

    private string SecondWeekTitle
    {
        get
        {
            var thisMonday = Sm.Today.GetPreviousMonday();
            var secondMonday = IsSecondWeekCurrentWeek ? thisMonday : thisMonday.AddDays(7);
            return $"2. Week {FormatDayMonth(secondMonday)}-{FormatDayMonth(secondMonday.AddDays(4))}";
        }
    }

    private string FirstWeekHtml => GenerateWeekHtml(1);
    private string SecondWeekHtml => GenerateWeekHtml(2);

    private string GenerateWeekHtml(int weekIndex)
    {
        if (!_initialized) return "initializing...";

        var thisMonday = Sm.Today.GetPreviousMonday();
        DateTime monday;

        if (weekIndex == 1)
            monday = IsFirstWeekCurrentWeek ? thisMonday : thisMonday.AddDays(-7);
        else
            monday = IsSecondWeekCurrentWeek ? thisMonday : thisMonday.AddDays(7);

        const int workDaysOfWeek = 5;
        var lines = new List<string>();

        // Use the same list structure as Who's Out so spacing can be controlled with one CSS rule.
        lines.Add("<ul class=\"sm-rows\">");

        for (int i = 0; i < workDaysOfWeek; i++)
        {
            var currentDate = monday.AddDays(i);
            var text = GetDayOfWeek(i).Substring(0, 3);

            if (Sm.IsHolidayForAllTeamMembers(currentDate))
            {
                var name = Sm.GetAllHolidayName(currentDate);
                lines.Add($"<li class=\"disabled\">{text} - {System.Net.WebUtility.HtmlEncode(name)}</li>");
            }
            else
            {
                var smName = Sm.GetScrumMasterName(currentDate, (weekIndex - 1) * workDaysOfWeek + i);
                var line = $"{text} - {System.Net.WebUtility.HtmlEncode(smName)}";

                // Keep existing visual cues, but apply them inside a <li>
                if (currentDate.Date < Sm.Today.Date)
                    line = $"<s class=\"completed\">{line}</s>";
                else if (currentDate.Date == Sm.Today.Date)
                    line = $"<b class=\"current-scrum-master\">{line}</b>";

                lines.Add($"<li>{line}</li>");
            }
        }

        lines.Add("</ul>");

        return string.Join("", lines);
    }

    private string WhosOutHtml
    {
        get
        {
            if (!_initialized) return "initializing...";
            if (Sm.IsLoading && !Sm.HasCachedData) return "initializing...";

            var items = Sm.WhosOut;
            var sb = new System.Text.StringBuilder();
            sb.Append("<ul class=\"sm-rows\">");

            static bool IsHolidayItem(SmBlazor.Models.WhosOutItem i)
                => !string.IsNullOrWhiteSpace(i.Reason)
                   && i.Reason.Trim().EndsWith("(holiday)", StringComparison.OrdinalIgnoreCase);

            static string GetHolidayName(SmBlazor.Models.WhosOutItem i)
            {
                var r = (i.Reason ?? string.Empty).Trim();
                return r.EndsWith("(holiday)", StringComparison.OrdinalIgnoreCase)
                    ? r.Substring(0, r.Length - "(holiday)".Length).Trim()
                    : r;
            }

            // Build a single list of renderable rows, then sort chronologically by period start.
            // If it's a period, Start is the first date, so it matches the requested ordering.
            var rows = new List<(DateTime Start, int Status, string Html)>();

            // --- Holiday grouped rows ---
            // We keep grouping key by Start+End+HolidayName+Country (from Sm.Holidays).
            var renderedHolidayKeys = new HashSet<string>(StringComparer.OrdinalIgnoreCase);

            foreach (var item in items)
            {
                if (!IsHolidayItem(item)) continue;

                var holidayName = GetHolidayName(item);

                // Find country for this holiday/date/name (if duplicates, join distinct).
                var countries = Sm.Holidays
                    .Where(h => h.Date.Date == item.Start.Date
                                && string.Equals(h.Name, holidayName, StringComparison.OrdinalIgnoreCase))
                    .Select(h => (h.Country ?? string.Empty).Trim())
                    .Where(c => c.Length > 0)
                    .SelectMany(c => c.Split(',', StringSplitOptions.RemoveEmptyEntries).Select(x => x.Trim()))
                    .Where(c => c.Length > 0)
                    .Distinct(StringComparer.OrdinalIgnoreCase)
                    .OrderBy(c => c)
                    .ToList();

                var countryKey = countries.Count == 0 ? "" : string.Join(",", countries).ToLowerInvariant();
                var key = $"{item.Start:O}|{item.End:O}|{holidayName.ToLowerInvariant()}|{countryKey}";
                if (!renderedHolidayKeys.Add(key)) continue;

                var group = items
                    .Where(i => IsHolidayItem(i)
                                && i.Start.Date == item.Start.Date
                                && i.End.Date == item.End.Date
                                && string.Equals(GetHolidayName(i), holidayName, StringComparison.OrdinalIgnoreCase))
                    .ToList();

                var members = group
                    .Select(i => Sm.GetTeamMember(i.MemberId)?.ShortName ?? i.MemberId)
                    .Distinct(StringComparer.OrdinalIgnoreCase)
                    .OrderBy(n => n)
                    .ToList();

                var cls = "";
                if (!group.All(g => g.Approved)) cls += " waiting";
                var status = group.Min(g => g.Status);
                cls += status == 0 ? " current" : status < 0 ? " completed" : " normal";

                var titleParts = new List<string> { $"{holidayName} (holiday)" };
                if (countries.Count > 0) titleParts.Add($"Country: {string.Join(", ", countries)}");
                titleParts.Add($"Members: {string.Join(", ", members)}");
                var title = System.Net.WebUtility.HtmlEncode(string.Join("\n", titleParts));

                // Keep the row compact: show only the period + country; holiday name is available in tooltip.
                var summaryText = $"{FormatDatePeriod(item.Start, item.End)}";
                if (countries.Count > 0)
                    summaryText += $"&nbsp;<span class=\"muted\">({System.Net.WebUtility.HtmlEncode(string.Join(", ", countries))})</span>";

                var html = $"<li class=\"{cls.Trim()}\" title=\"{title}\">" +
                           $"<details class=\"whosout-holiday\">" +
                           $"<summary>{summaryText}</summary>" +
                           $"<div class=\"holiday-members\">{System.Net.WebUtility.HtmlEncode(string.Join(", ", members))}</div>" +
                           $"</details>" +
                           "</li>";

                rows.Add((item.Start, status, html));
            }

            // --- Non-holiday rows ---
            foreach (var item in items)
            {
                if (IsHolidayItem(item)) continue;

                var cls = "";
                if (!item.Approved) cls += " waiting";
                cls += item.Status == 0 ? " current" : item.Status < 0 ? " completed" : " normal";

                var teamMember = Sm.GetTeamMember(item.MemberId);
                var shortName = teamMember?.ShortName ?? item.MemberId;

                var title = System.Net.WebUtility.HtmlEncode(item.Reason);
                var text = $"{System.Net.WebUtility.HtmlEncode(shortName)}&nbsp;{FormatDatePeriod(item.Start, item.End)}";

                var html = $"<li class=\"{cls.Trim()}\" title=\"{title}\">{text}</li>";
                rows.Add((item.Start, item.Status, html));
            }

            // Sort: chronological by period start (Start), then by Status (current first), then stable by HTML.
            // This ensures holidays don't jump to the top just because we grouped them.
            foreach (var row in rows
                         .OrderBy(r => r.Start)
                         .ThenBy(r => r.Status)
                         .ThenBy(r => r.Html, StringComparer.Ordinal))
            {
                sb.Append(row.Html);
            }

            sb.Append("</ul>");
            return sb.ToString();
        }
    }

    private static string FormatDatePeriod(DateTime start, DateTime end)
        => FormatDayMonth(start) == FormatDayMonth(end)
            ? FormatDayMonth(start)
            : $"{FormatDayMonth(start)}-{FormatDayMonth(end)}";

    private static string FormatDayMonth(DateTime date)
        => $"{date:dd.MM}";

    private static int CurrentWeekNumberFromFixedDate(DateTime date)
    {
        var fixedDate = new DateTime(2023, 1, 2);
        var diff = date.Date - fixedDate.Date;

        // Match the legacy JS logic:
        // Math.ceil((date - new Date(2023, 0, 2)) / 604800000)
        // In .NET: use days/7.0 and Ceiling (no +1), so Monday stays consistently in its bucket.
        return (int)Math.Ceiling(diff.TotalDays / 7.0);
    }

    private static bool IsFirstWeekCurrentWeekImpl(DateTime date)
        => CurrentWeekNumberFromFixedDate(date) % 2 == 0;

    // Replaced invalid array literal with a readonly array field and a safe accessor.
    private static readonly string[] DayNames = new[] { "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday" };

    private static string GetDayOfWeek(int day)
    {
        if (day < 0 || day >= DayNames.Length) return "";
        return DayNames[day];
    }

    private static string GetDayOfWeek(DayOfWeek d)
    {
        return d switch
        {
            DayOfWeek.Monday => "Monday",
            DayOfWeek.Tuesday => "Tuesday",
            DayOfWeek.Wednesday => "Wednesday",
            DayOfWeek.Thursday => "Thursday",
            DayOfWeek.Friday => "Friday",
            DayOfWeek.Saturday => "Saturday",
            DayOfWeek.Sunday => "Sunday",
            _ => ""
        };
    }

    private void ChangeDay(int offset)
    {
        // Compose new ?today= offset relative to current Sm.Today
        var newDate = Sm.Today.AddDays(offset).ToString("yyyy-MM-dd");
        var uri = Nav.ToAbsoluteUri(Nav.Uri);
        var baseUri = uri.GetLeftPart(UriPartial.Path);
        var newUri = $"{baseUri}?today={newDate}";
        Nav.NavigateTo(newUri, forceLoad: true);
    }
}

<style>
    .sm-spin {
        animation: sm-rotate 1s infinite linear;
        display: inline-block;
    }

    @@keyframes sm-rotate {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    /*
      One knob to tune row spacing across BOTH:
      - left week lists
      - right Who's Out list

      Try values like:
        --sm-row-line-height: 1.05;  (tighter)
        --sm-row-line-height: 1.15;  (default-ish)
        --sm-row-line-height: 1.30;  (looser)

      And/or padding:
        --sm-row-pad-y: 0px;  (tight)
        --sm-row-pad-y: 2px;  (roomier)
    */
    :root {
        --sm-row-line-height: 1.25;
        --sm-row-pad-y: 0px;
    }

    ul.sm-rows {
        margin: 0;
        padding-left: 18px; /* keep a nice bullet indent */
    }

    ul.sm-rows > li {
        margin: 0;
        padding: var(--sm-row-pad-y) 0;
        line-height: var(--sm-row-line-height);
    }

    /* Muted helper already used in holiday summary */
    .muted {
        opacity: 0.75;
        font-size: 0.95em;
    }

    details.whosout-holiday > summary {
        cursor: pointer;
        list-style: none;
    }

    /* Hide default marker in some browsers; keep the click/toggle behavior */
    details.whosout-holiday > summary::-webkit-details-marker {
        display: none;
    }

    details.whosout-holiday .holiday-members {
        margin-top: 2px;
        opacity: 0.9;
        font-size: 0.95em;
    }
</style>
